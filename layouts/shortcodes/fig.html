

{{/* ********************************   */}}
{{/* PARAMS                             */}}
{{/* ********************************   */}}

{{- $shortkey := .Get 0 -}}           
{{- $size := .Get 1 -}} 
    {{/* size can be just width as unitless integer (like "800")
         or as two integers separated by an x to indicate complete dimensions
         (like "400x200") */}}
{{- $displays := .Get 2 | default "img,blockquote,cite,link,footer,aside" -}}
{{- $resizeAnchor := .Get 3 | default "none" -}}

{{- $fullsizelinks := $.Site.Params.FullSizeLinks | default "false" -}}

{{- $width := $.Site.Params.ImageMaxWidth | default "800" -}}
{{- $height := "" -}}
{{- with $size -}}
    {{- if in . "x" -}}
        {{- $dims := split . "x" -}}
        {{- $width = index $dims 0 -}}
        {{- $height = index $dims (sub (len $dims) 1) -}}
    {{- else -}}
        {{- $width = . -}}
    {{- end -}}
{{- end -}}



{{/* ********************************   */}}
{{/* METADATA                           */}}
{{/* ********************************   */}}

{{/* metadata */}}
{{- $data := index site.Data.assets $shortkey -}}

{{- if not $data -}} 
    <p><strong>Warning:</strong> No data found for key <code> {{- $shortkey -}} </code></p> 
{{- end -}}

{{- $metadata := default "" (index $data "metadata") -}}
{{- $content := default "" (index $data "content") -}}



{{/* ********************************   */}}
{{/* IMAGE                              */}}
{{/* ********************************   */}}

{{/* adjust the image path to be relative to /_index.md bundle within /content (aka "/") */}}
{{- $fullimgrelref := path.Join "images" (print $shortkey "." (index $data "imgext")) -}}           

{{- if hugo.IsProduction -}}
    {{/* in production, use /content/_assets/_index.md as the headless page bundle for production image resources */}}
    
    {{- warnf "!!!! PRODUCTION RUN, images will be resized !!!!" -}}

    {{- $assets := site.GetPage "/_assets" -}}                     {{/* the headless bundle */}}
    {{- if not $assets -}}{{- errorf "No /_assets bundle visible; check mounts/excludes" -}}{{- end -}}
    {{- $image := $assets.Resources.Get $fullimgrelref -}}
    {{- with $image -}}

        {{- if eq $resizeAnchor "none" -}}
          {{- $resize := printf "%sx%s" $width $height -}}
          {{- $image = $image.Resize $resize -}}
        {{- else -}}
          {{- $resize := printf "%sx%s %s" $width $height $resizeAnchor -}}
          {{- $image = $image.Fill $resize -}}
        {{- end -}}

        {{- $fullimgrelref = $image.RelPermalink -}}
        {{- $width = $image.Width -}}
        {{- $height = $image.Height -}}

    {{- else -}}
        {{- errorf "No image resource at %s in bundle %s" $fullimgrelref $assets.Path -}} 
        {{- errorf "Using shortkey: %s" $shortkey -}} 
    {{- end -}}

{{- else -}}
    {{/* in development , use full path from site home (/) to statically reference file without resource processing  */}}
    {{- $fullimgrelref = path.Join "/_assets" $fullimgrelref -}}  {{/* must have leading slash */}}          
    {{- warnf "IMG $fullimgrelref: %s" $fullimgrelref -}}
{{- end -}}



{{/* ********************************   */}}
{{/* FIGURE                             */}}
{{/* ********************************   */}}

<figure class="image" style="max-width: {{- $width -}}px;">

    {{/* IMAGE  */}}
    {{- if in $displays "img" -}}
        <img src="{{- $fullimgrelref -}}" width="{{- $width -}}" height="{{- $height -}}" />
    {{- end -}}

    {{/* CONTENT */}}
    {{- if and $content (in $displays "blockquote") -}}
        {{- $quote := $content -}}
        {{- if .Inner -}}
            {{- $quote = .Inner -}}
        {{- end -}}
        {{- with $quote -}}
            <blockquote>{{- . | markdownify  -}}</blockquote>
        {{- end -}}
    {{- end -}}

    {{/* CITATION */}}
    {{- if or (in $displays "cite") (in $displays "link") -}}
        <figcaption>
            {{- if and $metadata (in $displays "cite") -}}
                {{- partial "citation" (dict "params" $metadata "ctx" $) -}}
            {{- end -}}
            {{- if and $fullimgrelref (in $displays "link") -}}
                {{- if $fullsizelinks -}}
                    <a class="origversion" href="{{- $fullimgrelref -}}">View largest available size.</a>
                {{- end -}}
            {{- end -}}
        </figcaption>
    {{- end -}}

    {{/* FOOTER */}}
    {{- if and $metadata (in $displays "footer") -}}
        {{- with $metadata.footer -}}
            <footer> {{- . | markdownify -}} </footer>
        {{- end -}}
    {{- end -}}

    {{/* NOTES */}}
    {{- if and $metadata (in $displays "aside") -}}
        <aside>
        {{- with $metadata.notes -}}
            <div class="notes">{{- . | markdownify -}}</div> 
        {{- end -}}
        </aside>
    {{- end -}}
</figure>


{{/*

Version 2

Figure code that uses a JSON encoded pre-compiled asset cache for improved
performance at scale.

The primary bottle neck in version 1 was file I/O at scale. 

A small Python script at undergo/scripts/compile-assets.py uses the Hugo config
file to find and recursively walk the asset file hierarchy, compiling metadata 
for use by the fig shortcode. By leveraging Hugo's built-in data handling 
capabilities, all asset data in the cache is automaticaly read once at server 
start-up and is then available instantaneously in memory in the shortcode. 

Furthermore, image manipulation functions in the shortcode are bypassed in 
the development environment, as in that enviroment, bandwidth is not a 
bottleneck, and I would prefer to optimize build performance in development 
instead.

(I started the cache compiling code in Go, both for consisency and performance,
but found that it was overly complicated for what I wanted to do. There was 
too much boilerplate, scaffolding, and other environmental dependencies. 
Python is much more straightforward, and I optimized it at the code level.)

The cache code is run and optimized in the following ways:

  - All scripts in undergo/scripts are added to the PATH by .envrc. 
  - All code is run from the top level Hugo directory.
  - All paths are relative to the top level Hugo directory, in other words, 
    starting with "content/...".
  - The code is aware of config.toml and retrieves site params from it, as does
    the fig shortcode. These are explained below.
  - The code uses Thread Pools for quasi-parallel file I/O.
  - A parallel index in JSON, with modification times for each key, is also 
    generated and stored so that the cache can be incrementally updated, 
    further minimizing file I/O.
  - Deleting the index file will force a full cache rebuild. (Of course, so 
    will deleting the cache file itself.)
  - Incremental updates automatically prune cache entries for files that have
    been moved or deleted.
  - A specific record can be updated by passing the --changed flag with a key.
  - An inotify watcher at undergo/scripts/watch-assets.sh will trigger a
    --changed call to compile-assets.py automatically whenever a *.md  file is 
    modified.
  - The shortcode is designed to be automatically backward compatible to version
    1 for sites that don't have cache data.
    
The inotify watcher may actually be suboptimal with large cache files, because
Hugo watches the data files themselves while the development server is running
and reloads the entire cache (and index) file each time it is modified. But Go
itself is very fast, so I will need to test this at scale.

*/}}
