

{{/* ********************************   */}}
{{/* PARAMS                             */}}
{{/* ********************************   */}}

{{- $shortkey := .Get 0 -}}           
{{- $size := .Get 1 -}} 
    {{/* size can be just width as unitless integer (like "800")
         or as two integers separated by an x to indicate complete dimensions
         (like "400x200") */}}
{{- $displays := .Get 2 | default "img,blockquote,cite,link,footer,aside" -}}
{{- $resizeAnchor := .Get 3 | default "none" -}}

{{- $fullsizelinks := $.Site.Params.FullSizeLinks | default "false" -}}

{{- $width := $.Site.Params.ImageMaxWidth | default "800" -}}
{{- $height := "" -}}
{{- with $size -}}
    {{- if in . "x" -}}
        {{- $dims := split . "x" -}}
        {{- $width = index $dims 0 -}}
        {{- $height = index $dims (sub (len $dims) 1) -}}
    {{- else -}}
        {{- $width = . -}}
    {{- end -}}
{{- end -}}



{{/* ********************************   */}}
{{/* METADATA                           */}}
{{/* ********************************   */}}

{{/* metadata */}}
{{- $data := index site.Data.assets $shortkey -}}

{{- if not $data -}} 
    <p><strong>Warning:</strong> No data found for key <code> {{- $shortkey -}} </code></p> 
{{- end -}}

{{- $metadata := default "" (index $data "metadata") -}}
{{- $content := default "" (index $data "content") -}}



{{/* ********************************   */}}
{{/* IMAGE                              */}}
{{/* ********************************   */}}

{{/* adjust the image path to be relative to /_index.md bundle within /content (aka "/") */}}
{{- $imgrelref := path.Join "images" (print $shortkey "." (index $data "imgext")) -}}           
{{- $origrelref := "" -}}

{{- if hugo.IsProduction -}}
    {{/* in production, use /content/_assets/_index.md as the headless page bundle for production image resources */}}
    
    {{- warnf "!!!! PRODUCTION RUN, images will be resized !!!!" -}}

    {{- $assets := site.GetPage "/_assets" -}}                     {{/* a headless bundle */}}
    {{- if not $assets -}}{{- errorf "No /_assets bundle visible; check mounts/excludes" -}}{{- end -}}
    {{- $image := $assets.Resources.Get $imgrelref -}}
    {{- $origrelref = $image.RelPermalink -}}
    {{- with $image -}}

        {{- if eq $resizeAnchor "none" -}}
          {{- $resize := printf "%sx%s" $width $height -}}
          {{- $image = $image.Resize $resize -}}
        {{- else -}}
          {{- $resize := printf "%sx%s %s" $width $height $resizeAnchor -}}
          {{- $image = $image.Fill $resize -}}
        {{- end -}}

        {{- $imgrelref = $image.RelPermalink -}}
        {{- $width = $image.Width -}}
        {{- $height = $image.Height -}}

    {{- else -}}
        {{- errorf "No image resource at %s in bundle %s" $imgrelref $assets.Path -}} 
    {{- end -}}

{{- else -}}
    {{/* in development , use full path from site home (/) to statically reference files without resource processing  */}}
    {{- $imgrelref = path.Join "/_assets" $imgrelref -}}  {{/* must have leading slash */}}          
    {{- $origrelref = $imgrelref -}}
{{- end -}}



{{/* ********************************   */}}
{{/* FIGURE                             */}}
{{/* ********************************   */}}

<figure class="image" style="max-width: {{- $width -}}px;">

    {{/* IMAGE  */}}
    {{- if in $displays "img" -}}
        <img src="{{- $imgrelref -}}" width="{{- $width -}}" height="{{- $height -}}" />
    {{- end -}}

    {{/* CONTENT */}}
    {{- if and $content (in $displays "blockquote") -}}
        {{- $quote := $content -}}
        {{- if .Inner -}}
            {{- $quote = .Inner -}}
        {{- end -}}
        {{- with $quote -}}
            <blockquote>{{- . | markdownify  -}}</blockquote>
        {{- end -}}
    {{- end -}}

    {{/* CITATION */}}
    {{- if or (in $displays "cite") (in $displays "link") -}}
        <figcaption>
            {{- if and $metadata (in $displays "cite") -}}
                {{- partial "citation" (dict "params" $metadata "ctx" $) -}}
            {{- end -}}
            {{- if and $imgrelref (in $displays "link") -}}
                {{- if $fullsizelinks -}}
                    <a class="origversion" href="{{- $origrelref -}}">View largest available size.</a>
                {{- end -}}
            {{- end -}}
        </figcaption>
    {{- end -}}

    {{/* FOOTER */}}
    {{- if and $metadata (in $displays "footer") -}}
        {{- with $metadata.footer -}}
            <footer> {{- . | markdownify -}} </footer>
        {{- end -}}
    {{- end -}}

    {{/* NOTES */}}
    {{- if and $metadata (in $displays "aside") -}}
        <aside>
        {{- with $metadata.notes -}}
            <div class="notes">{{- . | markdownify -}}</div> 
        {{- end -}}
        </aside>
    {{- end -}}
</figure>


{{/*

Fig Version 2

Figure code that uses a JSON encoded pre-compiled asset cache for improved
performance at scale.

The primary bottle neck in version 1 was file I/O at scale, and publishing
resources unnecessarily, generating much more HTML/XML than needed. 

A small Python script at undergo/scripts/compile-assets.py recursively walks
the asset file hierarchy, compiling metadata for use by the fig shortcode. By 
leveraging Hugo's built-in data handling capabilities, all asset data in the 
cache is automaticaly read once at server start-up and is then available 
instantaneously in memory in the shortcode. 

Furthermore, image manipulation functions in the shortcode are bypassed in 
the development environment, as in that enviroment, bandwidth is not a 
bottleneck, and I would prefer to optimize build performance in development 
instead.

(I started the cache compiling code in Go, both for consisency and performance,
but found that it was overly complicated for what I wanted to do. There was 
too much boilerplate, scaffolding, and other environmental dependencies. 
Python is much more straightforward, and I optimized it at the code level.)

The cache code is run and optimized in the following ways:

  - All scripts in undergo/scripts are added to the PATH by .envrc. 
  - All code is run from the top level Hugo directory.
  - Paths are relative to the top level Hugo directory, in other words, 
    starting with "content/...".
  - The code uses Thread Pools for quasi-parallel file I/O.
  - A parallel index in JSON, with modification times for each key, is also 
    generated and stored so that the cache can be incrementally updated, 
    further minimizing file I/O. This index is above /data so Hugo doesn't 
    ingest it when building.
  - Deleting the index file will force a full cache rebuild. (Of course, so 
    will deleting the cache file itself.)
  - Incremental updates automatically prune cache entries for files that have
    been moved or deleted.
  - A specific record can be updated by passing the --changed flag with a key.
  - An inotify watcher at undergo/scripts/watch-assets.sh will trigger a
    --changed call to compile-assets.py automatically whenever a *.md  file is 
    modified.
   
The fig shorcode was updated to use this cache and to be more clearly 
organized and performance optimized overall. For example, file globbing used
in version 1 has been replaced with explicit paths in version 2.

Configuration for undergo module and production build optimizations:

# theming and reusable code
[module]
  _merge = "deep"
  [[module.imports]]
    path = "github.com/ajsmith607/undergo"

  # don't render pages for *.md files under /content/_assets
  [[module.mounts]]
    source = "content"
    target = "content"
    excludeFiles = ["/_assets/**/*.md"]    # path is relative to /content
    # re-add only the section's _index.md so its front matter applies
    # and it can be referenced as the images resource bundle in fig production shortcode
  [[module.mounts]]
    source = "content/_assets/_index.md"
    target = "content/_assets/_index.md"

The content of /content/_assets/_index.md is:

---
# Controls the section node itself
headless: true
outputs: []
build:
  list: never
  render: never
  publishResources: true    # in order to see the images at all 

# Push the same rules to all descendants
cascade:
  _target:
    path: "/_assets/**"    # children of this section
  outputs: []
  build:
    list: never
    render: never
    publishResources: true
---

The development environment is further optimized by shutting down all 
unneccessary output, and moving _assets to /static, thus avoiding all resource
publishing and I/O while keeping paths consistent, so no special code is 
needed to handle this, the shortcode works automatically in each case. 
Images are not resized and therefore are not optimized themselves,  but in 
developement, data is served locally, so bandwith is not an issue.

# --- development overrides ---
[environments.development]
disableKinds = ["RSS", "sitemap", "robotsTXT", "taxonomy", "term"]
resourceDir = "/dev/shm/hugo-resources"

  [environments.development.module]
    # Dev: mount everything except _assets as content
    [[environments.development.module.mounts]]
      source = "content"
      target = "content"
      excludeFiles = ["/_assets/**"]

    # Dev: serve _assets raw as static files, limit to images
    [[environments.development.module.mounts]]
      source = "content/_assets"
      target = "static/_assets"
      includeFiles = ["**/*.jpg","**/*.jpeg","**/*.png","**/*.webp","**/*.gif"]

In production, images must be under /content, not /static or /resources. 
The images must be treated as resources for dynamic scaling (which can't be 
done in /static, but must also be visible so the full original can be seen when 
anyone clicks "view largest available image" (which can't be done in 
/resources). By convention, _assets is directly under /content to be available
sitewide, and is named with a leading underscore to avoid name collisions.

To summarize:
  - In production, images under _assets are treated as resources under /content.
  - In development, images under _assets are treated statically under /static.

Typically, run development hugo server in fast render mode with no http 
caching, as most edits in that environment are one content page at a time.

For more information on why images must be under content, see the code comments
in version 1 of the fig shortcode: figv1.html.


*/}}
