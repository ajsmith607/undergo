

{{/* ********************************   */}}
{{/* PARAMS                             */}}
{{/* ********************************   */}}

{{- $shortkey := .Get 0 -}}           
{{- $size := .Get 1 -}} 
    {{/* size can be just width as unitless integer (like "800")
         or as two integers separated by an x to indicate complete dimensions
         (like "400x200") */}}
{{- $displays := .Get 2 | default "img,blockquote,cite,link,footer,aside" -}}
{{- $resizeAnchor := .Get 3 | default "none" -}}

{{- $fullsizelinks := $.Site.Params.FullSizeLinks | default "false" -}}

{{- $width := $.Site.Params.ImageMaxWidth | default "800" -}}
{{- $height := "" -}}
{{- with $size -}}
    {{- if in . "x" -}}
        {{- $dims := split . "x" -}}
        {{- $width = index $dims 0 -}}
        {{- $height = index $dims (sub (len $dims) 1) -}}
    {{- else -}}
        {{- $width = . -}}
    {{- end -}}
{{- end -}}



{{/* ********************************   */}}
{{/* METADATA                           */}}
{{/* ********************************   */}}

{{/* metadata */}}
{{- $data := index site.Data.assets $shortkey -}}

{{- if not $data -}} 
    <p><strong>Warning:</strong> No data found for key <code> {{- $shortkey -}} </code></p> 
{{- end -}}

{{- $metadata := default "" (index $data "metadata") -}}
{{- $content := default "" (index $data "content") -}}



{{/* ********************************   */}}
{{/* IMAGE                              */}}
{{/* ********************************   */}}

{{/* adjust the image path to be relative to /_index.md bundle within /content (aka "/") */}}
{{- $imgrelref := path.Join "images" (print $shortkey "." (index $data "imgext")) -}}           
{{- $origrelref := "" -}}

{{- if hugo.IsProduction -}}
    {{/* in production, use /content/_assets/_index.md as the headless page bundle for production image resources */}}
    
    {{- warnf "!!!! PRODUCTION RUN, images will be resized !!!!" -}}

    {{- $assets := site.GetPage "/_assets" -}}                     {{/* a headless bundle */}}
    {{- if not $assets -}}{{- errorf "No /_assets bundle visible; check mounts/excludes" -}}{{- end -}}
    {{- $image := $assets.Resources.Get $imgrelref -}}
    {{- $origrelref = $image.RelPermalink -}}
    {{- with $image -}}

        {{- if eq $resizeAnchor "none" -}}
          {{- $resize := printf "%sx%s" $width $height -}}
          {{- $image = $image.Resize $resize -}}
        {{- else -}}
          {{- $resize := printf "%sx%s %s" $width $height $resizeAnchor -}}
          {{- $image = $image.Fill $resize -}}
        {{- end -}}

        {{- $imgrelref = $image.RelPermalink -}}
        {{- $width = $image.Width -}}
        {{- $height = $image.Height -}}

    {{- else -}}
        {{- errorf "No image resource at %s in bundle %s" $imgrelref $assets.Path -}} 
    {{- end -}}

{{- else -}}
    {{/* in development , use full path from site home (/) to statically reference files without resource processing  */}}
    {{- $imgrelref = path.Join "/_assets" $imgrelref -}}  {{/* must have leading slash */}}          
    {{- $origrelref = $imgrelref -}}
{{- end -}}



{{/* ********************************   */}}
{{/* FIGURE                             */}}
{{/* ********************************   */}}

<figure class="image" style="max-width: {{- $width -}}px;">

    {{/* IMAGE  */}}
    {{- if in $displays "img" -}}
        <img src="{{- $imgrelref -}}" width="{{- $width -}}" height="{{- $height -}}" />
    {{- end -}}

    {{/* CONTENT */}}
    {{- if and $content (in $displays "blockquote") -}}
        {{- $quote := $content -}}
        {{- if .Inner -}}
            {{- $quote = .Inner -}}
        {{- end -}}
        {{- with $quote -}}
            <blockquote>{{- . | markdownify  -}}</blockquote>
        {{- end -}}
    {{- end -}}

    {{/* CITATION */}}
    {{- if or (in $displays "cite") (in $displays "link") -}}
        <figcaption>
            {{- if and $metadata (in $displays "cite") -}}
                {{- partial "citation" (dict "params" $metadata "ctx" $) -}}
            {{- end -}}
            {{- if and $imgrelref (in $displays "link") -}}
                {{- if $fullsizelinks -}}
                    <a class="origversion" href="{{- $origrelref -}}">View largest available size.</a>
                {{- end -}}
            {{- end -}}
        </figcaption>
    {{- end -}}

    {{/* FOOTER */}}
    {{- if and $metadata (in $displays "footer") -}}
        {{- with $metadata.footer -}}
            <footer> {{- . | markdownify -}} </footer>
        {{- end -}}
    {{- end -}}

    {{/* NOTES */}}
    {{- if and $metadata (in $displays "aside") -}}
        <aside>
        {{- with $metadata.notes -}}
            <div class="notes">{{- . | markdownify -}}</div> 
        {{- end -}}
        </aside>
    {{- end -}}
</figure>


